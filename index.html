<html>

<head>
	<style>
		body {
			background-color: black;
			color: white;
		}

		#wrapper {
			height: 100%;
			width: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
			user-select: none;
			font-size: 20px;
			overflow: hidden;
		}

		#content {
			display: flex;
			flex-direction: column;
			text-align: center;
		}

		#content div {
			display: inline-table;
			justify-content: center;
			align-items: center;
			width: 20px;
			height: 20px;
			box-shadow: inset 0px 0px 0px 0.25px #111;
		}

		.nav {
			cursor: pointer;
		}

		.nav:hover {
			box-shadow: inset 0px 0px 0px 2px #fff !important;
		}
	</style>
	<script type="module">
		import init, { click } from './pkg/roguelike.js';
		window.wasmclick = click;
		await init();

		window.fnc = function c(x, y) {
			render(window.wasmclick(x, y));
		}

		function render(wasm_out) {
			let canvases = JSON.parse(wasm_out)["canvases"];
			if (!window.elems) {
				window.elems = [];
				let content = document.getElementById("content");
				content.innerHTML = "";
				let canvas = canvases[0];
				for (let y = canvases[0][0].length-1; y >= 0; y--) {
					let row_div = document.createElement("div");
					for (let x = 0; x < canvases[0].length; x++) {
						let elem = document.createElement("div");
						if (!(x in window.elems)){
							window.elems[x] = [];
						}
						window.elems[x][y] = elem;
						row_div.appendChild(elem);
					}
					content.appendChild(row_div);
				}
			}
			for (let i in canvases) {
				window.frame = 0;
				let canvas = canvases[i];
				setTimeout(() => {
					for (let x in canvas) {
						for (let y in canvas[x]) {
							let elem = window.elems[x][y];
							if ("bg" in canvas[x][y]) {
								elem.style.backgroundColor = canvas[x][y]["bg"];
							} else {
								elem.style.backgroundColor = null;
							}
							if (canvas[x][y]["c"] === " " && "bg" in canvas[x][y]) {
								elem.innerText = ".";
								elem.style.color = canvas[x][y]["bg"];
							} else {
								elem.innerText = canvas[x][y]["c"];
							}
							if (window.frame === canvases.length - 1) {
								elem.setAttribute("onmousedown", "window.fnc(" + x + "," + y + ")");
								if ("m" in canvas[x][y]) {
									elem.classList.add("nav");
								}
							} else if (window.frame === 0) {
								elem.classList.remove("nav");
								elem.removeAttribute("onmousedown");
							}
						}
					}
					window.frame++;
				}, 64 * i);
			}
		}

		window.fnc(0, 0);

	</script>
</head>

<body>
	<div id="wrapper">
		<pre id="content">
			<div>
				<div>l</div>
				<div>o</div>
				<div>a</div>
				<div>d</div>
				<div>i</div>
				<div>n</div>
				<div>g</div>
			</div>
		</pre>
	</div>
</body>

</html>